<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtrage des données Excel avec Carte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #fff;
            text-align: center;
            width: 60%;
            margin: auto;
        }
        #map {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
        .filter-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            text-align: left;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .filter-group h4 {
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .filter-group button {
            margin: 5px 0;
            padding: 10px;
            border: none;
            background-color: #444;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
            width: 150px;
            text-align: left;
        }
        .filter-group button.active {
            background-color: #FF9800;
            color: white;
        }
        .filter-group button:hover {
            background-color: #555;
        }
        table {
            width: 100%;
            margin: auto;
            border-collapse: collapse;
            background-color: #333;
        }
        th, td {
            border: 1px solid #666;
            padding: 10px;
            text-align: center;
            color: #fff;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var map = L.map('map').setView([44.8378, -0.57918], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>'
            }).addTo(map);
        });

        let excelData = [];

        function handleFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                excelData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                console.log("Données Excel chargées :", excelData.slice(0, 5));
                populateFilters();
            };
        }
        
        function populateFilters() {
            document.getElementById("quartier").innerHTML = "<h4>Quartier</h4>";
            document.getElementById("hierarchisation").innerHTML = "<h4>Hiérarchisation</h4>";
            document.getElementById("sousCategorie").innerHTML = "<h4>Sous-catégorie</h4>";
            document.getElementById("projet").innerHTML = "<h4>Projet</h4>";
            createFilterButtons("quartier", 0);
        }
        
        function createFilterButtons(filterId, columnIndex, previousSelection = null) {
            const container = document.getElementById(filterId);
            container.innerHTML = "<h4>" + container.querySelector("h4").textContent + "</h4>";
            const values = new Set();
            
            excelData.slice(1).forEach(row => {
                if (previousSelection === null || row[columnIndex - 1] === previousSelection) {
                    values.add(row[columnIndex]);
                }
            });
            
            values.forEach(value => {
                if (value) {
                    const button = document.createElement("button");
                    button.textContent = value;
                    button.onclick = function() {
                        document.querySelectorAll(`#${filterId} button`).forEach(btn => btn.classList.remove("active"));
                        button.classList.add("active");
                        populateFiltersForSelection(filterId, columnIndex + 1, value);
                        updateResults();
                    };
                    container.appendChild(button);
                }
            });
        }
        
        function populateFiltersForSelection(filterId, nextColumnIndex, selectedValue) {
            if (filterId === "quartier") {
                createFilterButtons("hierarchisation", nextColumnIndex, selectedValue);
            } else if (filterId === "hierarchisation") {
                createFilterButtons("sousCategorie", nextColumnIndex, selectedValue);
            } else if (filterId === "sousCategorie") {
                createFilterButtons("projet", nextColumnIndex, selectedValue);
            }
        }
        
        function updateResults() {
            const resultsTable = document.getElementById("resultsTable");
            resultsTable.innerHTML = "";
            
            const selectedQuartier = document.querySelector("#quartier button.active")?.textContent || "";
            const selectedHierarchisation = document.querySelector("#hierarchisation button.active")?.textContent || "";
            const selectedSousCategorie = document.querySelector("#sousCategorie button.active")?.textContent || "";
            const selectedProjet = document.querySelector("#projet button.active")?.textContent || "";
            
            const filteredData = excelData.slice(1).filter(row =>
                (selectedQuartier === "" || row[0] === selectedQuartier) &&
                (selectedHierarchisation === "" || row[1] === selectedHierarchisation) &&
                (selectedSousCategorie === "" || row[2] === selectedSousCategorie) &&
                (selectedProjet === "" || row[3] === selectedProjet)
            );
            
            filteredData.forEach(row => {
                const tr = document.createElement("tr");
                for (let i = 4; i < row.length; i++) {
                    const td = document.createElement("td");
                    td.textContent = row[i];
                    tr.appendChild(td);
                }
                resultsTable.appendChild(tr);
            });
        }
    </script>
</head>
<body>
    <h2>Carte Interactive</h2>
    <div id="map"></div>

    <h2>Charger un fichier Excel</h2>
    <input type="file" accept=".xlsx, .xls" onchange="handleFile(event)">
    
    <h3>Filtrer les données</h3>
    <div class="filter-container">
        <div class="filter-group" id="quartier"><h4>Quartier</h4></div>
        <div class="filter-group" id="hierarchisation"><h4>Hiérarchisation</h4></div>
        <div class="filter-group" id="sousCategorie"><h4>Sous-catégorie</h4></div>
        <div class="filter-group" id="projet"><h4>Projet</h4></div>
    </div>
    
    <h3>Résultats</h3>
    <table>
        <thead>
            <tr id="resultsHeader"></tr>
        </thead>
        <tbody id="resultsTable"></tbody>
    </table>
</body>
</html>
